{% extends "layout.html" %}
{% block title %}SIGNUP PAGE{% endblock %}
{% block head %}

{% endblock %}
{% block content %}
    <form id="signupForm" method="post" enctype="multipart/form-data">
        <span class="regNameState"></span><br>
        <input type="text" name="regName" placeholder="아이디를 입력해주세요"><br>
        <input type="password" name="regPass" placeholder="패스워드를 입력해주세요"><br>
        <input type="password" name="chkPass" placeholder="패스워드를 다시입력해주세요"><br>
        <span class="regMailState"></span><br>
        <input type="email" name="regMail" placeholder="이메일을 형식에 맞춰 작성해주세요"><br>
        <input type="file" name="regPic"><br>
        <textarea name="regCom" placeholder="소개글을 작성해주세요."></textarea>
        <button type="button" onclick="signupCheck()">회원가입</button>
    </form>

    <script>

    const usernameInput = document.querySelector('input[name="regName"]');
    const usermailInput = document.querySelector('input[name="regMail"]');
    const usernameState = document.querySelector('.regNameState');
    const usermailState = document.querySelector('.regMailState');
    const userpassInput = document.querySelector('input[name="regPass"]');
    const userchkpassInput = document.querySelector('input[name="chkPass"]');

    function isValidEmail(email) {
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailPattern.test(email);
    }

    let usernameBool = false;
    let usermailBool = false;

    usernameInput.addEventListener('keyup', function() {
        const username = usernameInput.value.trim();
        if (username.length > 4) {
            fetch('/acc/checkNameDup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: username })
            })
            .then(response => response.json())
            .then(data => {
                if (data.is_duplicate) {
                    usernameState.innerHTML = "사용중인 아이디입니다.";
                    usernameBool = false;
                } else {
                    usernameState.innerHTML = "사용가능한 아이디입니다.";
                    usernameBool = true;
                }
            })
            .catch(error => console.error('Error:', error));
        } else {
            usernameState.innerHTML = "아이디는 5자리 이상으로 설정해주세요.";
            usernameBool = false;
        }
    });

    usermailInput.addEventListener('keyup', function() {
        const usermail = usermailInput.value.trim();
        if (!isValidEmail(usermail)) {
            usermailState.innerHTML = "유효하지 않은 이메일 형식입니다.";
            usermailBool = false;
        } else {
            fetch('/acc/checkMailDup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: usermail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.is_duplicate) {
                    usermailState.innerHTML = "이미 가입된 이메일입니다.";
                    usermailBool = false;
                } else {
                    usermailState.innerHTML = "사용가능한 이메일입니다.";
                    usermailBool = true;
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    function signupCheck() {
        const username = usernameInput.value.trim();
        const usermail = usermailInput.value.trim();
        const userpass = userpassInput.value.trim();
        const userchkpass = userchkpassInput.value.trim();
        if(!usernameBool){
            alert("입력하신 아이디를 확인해주세요");
        }else if(userpass != userchkpass){
            alert("패스워드가 서로 일치하지 않습니다.");
        }else if(!usermailBool){
            alert("입력하신 이메일을 확인해주세요");
        }else{
            document.getElementById("signupForm").submit();
        }
    }
    </script>
{% endblock %}