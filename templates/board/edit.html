{% extends "layout.html" %}
{% block title %}CREATE POST{% endblock %}
{% block head %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/custom.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.1.3/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style>
        .fixed-buttons {
            position: fixed;
            top: 100px;
            background-color: #77ff0078;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 20px;
            line-height: 40px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
            z-index: 1; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— ê³ ì • */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .fixed-buttons:hover{
            opacity: 0.5;
        }
        .check-button{
            right: 80px;
        }
        .back-button{
            right: 30px;
        }
    </style>
{% endblock %}
{% block content %}
<div class="customBody">
    <form id="createPostForm" method="post">
        <div class="horizontal margin_bottom">
            <textarea name="title" id="custom_title" class="margin_right" placeholder="ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”" required>{{ post.title }}</textarea>
            <div class="horizontal">
                <div class="horizontal margin_right">
                    <input type="checkbox" name="secretCheck" id="check1" {% if post.secret_mode %}checked{% endif %}>
                    <label for="check1" class="marginRight16"></label>
                    ë¹„ë°€ê¸€
                </div>
                
                    {% if current_user.grade == 1 %}
                    <div class="horizontal margin_right">
                        <input type="checkbox" name="noticeCheck" id="check2" {% if post.notice_mode %}checked{% endif %}>
                        <label for="check2" class="marginRight16 marginLeft16"></label>
                        ê³µì§€ê¸€
                    </div>
                    {% endif %}
                
                <button type="submit" class="fixed-buttons check-button" title="ìˆ˜ì •ì™„ë£Œ" onclick="submitCreatePost()">âœ…</button>
                <button type="button" class="fixed-buttons back-button" title="ë’¤ë¡œê°€ê¸°" onclick="goBackPage()">ğŸ”™</button>
            </div>
        </div>
        <div>
            <textarea name="problemUrl" id="custom_url" placeholder="ë¬¸ì œ URLì„ ì…ë ¥í•´ ì£¼ì„¸ìš”">{{ post.problem_url }}</textarea>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <textarea name="body" id="custom_contents" class="markdownInput" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”" required>{{ post.body }}</textarea>
            </div>
            <div class="col-lg-6">
                <div class="markdownPreview"></div>
            </div>
        </div>
    </form>
</div>
<script>
    
    // textarea ìš”ì†Œì™€ ë¯¸ë¦¬ë³´ê¸°ë¥¼ í‘œì‹œí•  ìš”ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    var markdownInput = document.querySelector('.markdownInput');
    var markdownPreview = document.querySelector('.markdownPreview');

    // textareaì— ì…ë ¥ ë‚´ìš©ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    markdownInput.addEventListener('input', function() {
        // ì…ë ¥ëœ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì™€ì„œ HTMLë¡œ ë³€í™˜í•˜ì—¬ ë¯¸ë¦¬ë³´ê¸° ìš”ì†Œì— ì ìš©í•©ë‹ˆë‹¤.
        markdownPreview.innerHTML = marked(markdownInput.value);
        markdownPreview.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightBlock(block);
        });
    });

    // ì‚¬ìš©ìê°€ ì—”í„°ë¥¼ ì…ë ¥í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    markdownInput.addEventListener('keydown', function(event) {
        if (event.keyCode === 13) {
            // Enter í‚¤ë¥¼ ëˆ„ë¥´ë©´ ì…ë ¥ ë‚´ìš©ì´ ë³€ê²½ë˜ë¯€ë¡œ input ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œì¼œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            var inputEvent = new Event('input');
            markdownInput.dispatchEvent(inputEvent);
        }else if(event.keyCode === 9) {
            event.preventDefault(); // ê¸°ë³¸ ë™ì‘(íƒ­ ì´ë™)ì„ ë§‰ìŠµë‹ˆë‹¤.
            var cursorPos = markdownInput.selectionStart; // ì»¤ì„œì˜ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            var textBeforeCursor = markdownInput.value.substring(0, cursorPos); // ì»¤ì„œ ì•ì˜ í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            var textAfterCursor = markdownInput.value.substring(cursorPos); // ì»¤ì„œ ë’¤ì˜ í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            markdownInput.value = textBeforeCursor + '\t' + textAfterCursor; // íƒ­ ë¬¸ìë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.
            markdownInput.selectionStart = cursorPos + 1; // ì»¤ì„œë¥¼ ì´ë™í•©ë‹ˆë‹¤.
            markdownInput.selectionEnd = cursorPos + 1;
            markdownInput.focus(); // textareaì— í¬ì»¤ìŠ¤ë¥¼ ë§ì¶¥ë‹ˆë‹¤.
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        const markdownView = document.querySelector('.markdownPreview');
        const markdownContent = document.querySelector('.markdownInput').textContent;
        markdownPreview.innerHTML = marked(markdownContent);
    });
    
    function goBackPage(){
        window.history.back();
    }
    
</script>
{% endblock %}