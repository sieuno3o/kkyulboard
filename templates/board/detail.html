{% extends "layout.html" %}
{% block title %}POST DETAIL{% endblock %}
{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.1.3/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

{% endblock %}

{% block content%}
<div class="container">
    <div class="center">
        <div class="main">
            <div class="boardTitle">
                <h1>{{post.title}}</h1>
                <p>작성자 {{post.user.username}}</p>
            </div>
            <div class="detail-mainText">
                <div class="markdownView">{{post.body}}</div>
            </div>

            <div class="row comment-text-line d-flex justify-content-start align-content-center">
                <div class="col-md-6">
                    <div>
                        <button class="btn btn-sm btn-like" data-like-on="{{ likeContext.like_on }}" data-login="{{ userContext.is_login }}">
                            {% if likeContext.like_on == 1 %}
                                <img class="likeImage" src="{{ url_for('static', filename='/like.png') }}" alt="">
                            {% else %}
                                <img class="likeImage" src="{{ url_for('static', filename='/unlike.png') }}" alt="">
                            {% endif %}
                        </button>
                        <h3>좋아요 {{ likeContext.count }}</h3>
                        <h3 class="mx-3">댓글 {{ comCount }} 개</h3>
                    </div>
                </div>
            </div>

            <div class="commentBox text-center" style="background-color: rgba(208, 239, 201, 0.317); padding: 10px 0px 10px 30px">
                {% for com in comments %}
                    <div class="row mt-2">
{#                        <div class="col-lg-2 horizontal text-start">#}
                        <div class="col-lg-2 vertical text-start">
                            {% if com.user.userpic %}
                                <img class="commentImage" src="{{ url_for('static', filename=com.user.userpic) }}" alt="">
                            {% else %}
                                <img class="commentImage" src="/static/noimage.png" alt="">
                            {% endif %}
                            <div class="commentText">{{ com.user.username }}</div>
                        </div>
                        <div class="col-lg-7 comments text-start">
                            <textarea class="commentInput" data-comm-id="{{ com.comment_id }}" style="border: none; background-color: transparent; width:100%; height: 100%;" readonly>{{com.comments}}</textarea>
                        </div>
                        <div class="col-lg-1 createTime" data-created-at="{{com.created_at}}"></div>
                        {% if userContext.id == com.user.user_id or userContext.grade == 1 %}
                        <div class="col-lg-2">
                            <button class="btn btn-sm btn-request">✏️</button>
                            <button class="btn btn-sm btn-request" data-comm-id="{{ com.comment_id }}">❌</button>
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            
            {% if current_user.is_authenticated %}

                <form id="comment-form" action="{{url_for('board.add_comment')}}" method="post">
                    <div class="row mt-4">
                        <div class="col-11">
                            <input type="hidden" name="postId" value="{{ post.post_id }}">
                            <textarea id="text-comments" class="form-control" rows="3" placeholder="남기실 말씀을 적어주세요."
                                name="comments"></textarea>
                        </div>
                        <div class="col-1">
                            <button id="btn-register" type="submit" class="btn btn-theme-color mt-2">등록</button>
                        </div>
                    </div>
                </form>
            {% endif %}
            
        </div>
    </div>
</div>
<script>
    
    document.addEventListener('DOMContentLoaded', function() {
        const markdownView = document.querySelector('.markdownView');
        const markdownContent = markdownView.textContent;
        markdownView.innerHTML = marked(markdownContent);
    });

    function timeSince(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        let interval = Math.floor(seconds / 31536000);

        if (interval >= 1) {
            return interval + " 년 전";
        }
        interval = Math.floor(seconds / 2592000);
        if (interval >= 1) {
            return interval + " 개월 전";
        }
        interval = Math.floor(seconds / 86400);
        if (interval >= 1) {
            return interval + " 일 전";
        }
        interval = Math.floor(seconds / 3600);
        if (interval >= 1) {
            return interval + " 시간 전";
        }
        interval = Math.floor(seconds / 60);
        if (interval >= 1) {
            return interval + " 분 전";
        }
        return Math.floor(seconds) + " 초 전";
    }

    // 모든 createTime 클래스를 가진 요소를 가져와서 시간을 설정합니다.
    const createTimeElements = document.querySelectorAll('.createTime');
    createTimeElements.forEach(function(element) {
        const createdTime = element.getAttribute('data-created-at');
        element.innerText = timeSince(createdTime);
    });

    // 수정 버튼을 클릭했을 때 실행되는 함수
    function activateEditField(button) {
        // 버튼을 클릭한 부모 요소인 수정 칸을 찾습니다.
        var editField = button.closest('.row').querySelector('.commentInput');
        
        editField.removeAttribute('readonly');
        editField.focus();
        editField.setSelectionRange(editField.value.length, editField.value.length);

        // 연필 아이콘을 체크 아이콘으로 변경합니다.
        button.innerHTML = '✅';
    }

    // 체크박스가 아닌 수정 버튼을 클릭했을 때 실행되는 함수
    function handleEditButtonClick(button) {
        // 댓글 데이터를 가져옵니다.
        var selectInput = button.closest('.row').querySelector('.commentInput');
        var commentData = selectInput.value;
        var commentNo = selectInput.getAttribute('data-comm-id');

        fetch("/board/update_comment", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                commentNo: commentNo,
                commentData: commentData
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // 서버 응답에 따른 처리를 수행합니다.
            location.reload();
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });

        // 요청을 보내는 대신 콘솔에 댓글 데이터를 출력합니다.
        console.log('댓글 데이터:', commentData, commentNo);
    }

    function removeData(button){
        removeId = button.getAttribute('data-comm-id');
        fetch("/board/delete_comment", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                removeId: removeId
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // 서버 응답에 따른 처리를 수행합니다.
            location.reload();
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
    }

    // 모든 수정 버튼에 클릭 이벤트 리스너를 추가합니다.
    var editButtons = document.querySelectorAll('.btn-request');
    editButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            if(button.innerHTML == "❌"){
                removeData(button);
            }else if(button.innerHTML == "✅"){
                handleEditButtonClick(button);
            }else{
                activateEditField(button);
            }
        });
    });

    // Enter 키를 눌렀을 때 실행되는 함수
    function handleEnterKey(event) {
        if (event.keyCode === 13) {
            // 현재 이벤트가 발생한 요소를 찾습니다.
            var currentElement = event.target;

            // 체크박스가 아니고 수정 버튼인 경우에만 처리합니다.
            if (currentElement.classList.contains('commentInput')) {
                handleEditButtonClick(currentElement);
            }
        }
    }

    // 모든 입력란에 keydown 이벤트 리스너를 추가합니다.
    var inputFields = document.querySelectorAll('.commentInput');
    inputFields.forEach(function(input) {
        input.addEventListener('keydown', handleEnterKey);
    });

    // 페이지 로드 이벤트가 발생했을 때 실행되는 함수
    window.onload = function() {
        // 이전에 저장한 스크롤 위치를 가져옵니다.
        var scrollPosition = sessionStorage.getItem('scrollPosition');

        // 이전 스크롤 위치가 존재하는 경우에만 스크롤을 이동합니다.
        if (scrollPosition) {
            window.scrollTo(0, scrollPosition);
        }
    };

    // 페이지 unload 이벤트가 발생했을 때 실행되는 함수
    window.onbeforeunload = function() {
        // 현재 스크롤 위치를 저장합니다.
        sessionStorage.setItem('scrollPosition', window.scrollY);
    };

    // 좋아요 버튼이 눌릴 때마다 값을 toggle하여 서버에 전달합니다.
    function toggleLikeButton(button) {
        // 로그인되어 있지 않으면 이벤트를 pass 한다.
        const isLogin = button.getAttribute('data-login') === '1';
        if (isLogin === false) {
            return
        }

        const likeOn = button.getAttribute('data-like-on') === '1' ? '0' : '1';
        fetch("/board/set_like", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                likeOn: likeOn
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // 서버 응답에 따른 처리를 수행합니다.
            location.reload();
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
    }

    // 좋아요 버튼에 클릭 이벤트 리스너를 추가합니다.
    var likeButtons = document.querySelectorAll('.btn-like');
    likeButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            toggleLikeButton(button);
        });
    });

</script>

{% endblock %}