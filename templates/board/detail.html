{% extends "layout.html" %}
{% block title %}POST DETAIL{% endblock %}
{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.1.3/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<style>
    /* ë²„íŠ¼ ë””ìì¸ */
/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.fixed-buttons {
    position: fixed;
    bottom: 70px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    font-size: 20px;
    line-height: 40px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: background-color 0.3s;
    z-index: 1; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— ê³ ì • */
    display: flex;
    justify-content: center;
    align-items: center;
}

.add-button {
    right: 20px;
}

.add-button:hover{
    opacity: 0.5;
}

.edit-button{
    right: 120px;
    display: none;
}
.remove-button{
    right: 70px;
    display: none;
}
</style>
{% endblock %}

{% block content%}
<div class="detail-container">
    <div class="detail-center">
        <div class="detail-main">
            <div class="detail-title">
                <div style="display: flex; flex-direction: column;">
                    <span style="font-size: 30px;"><b>{{post.title}}</b></span>
                    <div class="horizontal d-flex justify-content-start">
                        <span>ì¡°íšŒìˆ˜</span>&nbsp;{{ post.click_count }}&nbsp;&nbsp;|&nbsp;&nbsp;
                        <span>ì¢‹ì•„ìš”</span>&nbsp;{{ post.likes | length }}&nbsp;&nbsp;|&nbsp;&nbsp;
                        <span>ëŒ“ê¸€</span>&nbsp;{{ post.comments | length }}
                    </div>
                    <div class="horizontal d-flex justify-content-start">
                        <span>ë¬¸ì œ URL</span>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="{{ post.problem_url }}">{{ post.problem_url }}</a>
                    </div>
                </div>
                <div style="margin-right: 15px;">
                    <span>ì‘ì„±ì {{post.user.username}}&nbsp;|&nbsp;{{ post.updated_at.strftime("%Y.%m.%d. %H:%M") }}</span>
                </div>
            </div>
            <div class="detail-mainText">
                <div class="markdownView">{{post.body}}</div>
            </div>
            <div class="row comment-text-line">
                <div class="col-md-6 d-flex justify-content-start align-content-center">
                    <div class="btn-like-container" >
                        <button class="btn btn-sm btn-like" data-like-on="{{ likeContext.like_on }}"
                                data-login="{{ userContext.is_login }}">
                            {% if likeContext.like_on == 1 %}
                                <img class="likeImage" src="{{ url_for('static', filename='/like.png') }}" alt="">
                            {% else %}
                                <img class="likeImage" src="{{ url_for('static', filename='/unlike.png') }}" alt="">
                            {% endif %}
                        </button>
                    </div>
                    <div>
                        <h3>ì¢‹ì•„ìš” {{ likeContext.count }}</h3>
                        <h3 class="mx-3">ëŒ“ê¸€ {{ comCount }} ê°œ</h3>
                    </div>
                </div>

            </div>

            <div class="commentBox text-center" style="background-color: rgba(208, 239, 201, 0.317); padding: 10px 0px 10px 30px">
                {% for com in comments %}
                    <div class="row mt-2">
{#                        <div class="col-lg-2 horizontal text-start">#}
                        <div class="col-lg-2 vertical text-start">
                            {% if com.user.userpic %}
                                <img class="commentImage" src="{{ url_for('static', filename=com.user.userpic) }}" alt="">
                            {% else %}
                                <img class="commentImage" src="/static/noimage.png" alt="">
                            {% endif %}
                            <div class="commentText">{{ com.user.username }}</div>
                        </div>
                        <div class="col-lg-7 comments text-start">
                            <textarea class="commentInput" data-comm-id="{{ com.comment_id }}" style="border: none; background-color: transparent; width:100%; height: 100%;" readonly>{{com.comments}}</textarea>
                        </div>
                        <div class="col-lg-1 createTime" data-created-at="{{com.created_at}}"></div>
                        {% if userContext.id == com.user.user_id or userContext.grade == 1 %}
                        <div class="col-lg-2">
                            <button class="btn btn-sm btn-request">âœï¸</button>
                            <button class="btn btn-sm btn-request" data-comm-id="{{ com.comment_id }}">ğŸ—‘ï¸</button>
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            
    

            {% if current_user.is_authenticated %}

                <form id="comment-form" action="{{url_for('board.add_comment')}}" method="post">
                    <div class="row mt-4">
                        <div class="col-11">
                            <input type="hidden" name="postId" value="{{ post.post_id }}">
                            <textarea id="text-comments" class="form-control" rows="3" placeholder="ë‚¨ê¸°ì‹¤ ë§ì”€ì„ ì ì–´ì£¼ì„¸ìš”."
                                name="comments" required></textarea>
                        </div>
                        <div class="col-1">
                            <button id="btn-register" type="submit" class="btn btn-theme-color mt-2">ë“±ë¡</button>
                        </div>
                    </div>
                </form>
            {% endif %}

            <div class="col horizontal d-flex justify-content-start mt-4">
                <form action="{{url_for('board.prev_post')}}" method="post">
                    <button class="btn btn-sub-color">ì´ì „ê¸€</button>
                </form>
                <form action="{{url_for('board.next_post')}}" method="post">
                    <button class="btn btn-sub-color mx-2">ë‹¤ìŒê¸€</button>
                </form>
                <form action="{{url_for('board.index')}}" method="get">
                    <button class="btn btn-theme-color mx-2">ëª©ë¡</button>
                </form>
            </div>
        </div>


        {% if current_user.grade == 1 or current_user == post.user %}
            <button class="add-button fixed-buttons" onclick="showTwoButton()">+</button>
            <a href="{{ url_for('board.editPost', post_id=post.post_id )}}"><button class="edit-button fixed-buttons">âœï¸</button></a>
            <a href="{{ url_for('board.deletePost', post_id=post.post_id )}}"><button class="remove-button fixed-buttons">ğŸ—‘ï¸</button></a>
        {% endif %}
    

    </div>
</div>
<script>
    function showTwoButton() {
        addButton = document.querySelector('.add-button');
        editButton = document.querySelector('.edit-button');
        removeButton = document.querySelector('.remove-button');
        if(addButton.innerHTML == "+"){
            addButton.innerHTML = "-";
            addButton.style.opacity = 0.5;
            editButton.style.display = "block";
            removeButton.style.display = "block";
        }else{
            addButton.innerHTML = "+";
            addButton.style.opacity = 1;
            editButton.style.display = "none";
            removeButton.style.display = "none";
        }
    }

    function editItem() {
        // ìˆ˜ì • ê¸°ëŠ¥ êµ¬í˜„
    }

    function deleteItem() {
        // ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„
    }

    document.addEventListener('DOMContentLoaded', function() {
        const markdownView = document.querySelector('.markdownView');
        const markdownContent = markdownView.textContent;
        markdownView.innerHTML = marked(markdownContent);
    });

    function timeSince(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        let interval = Math.floor(seconds / 31536000);

        if (interval >= 1) {
            return interval + " ë…„ ì „";
        }
        interval = Math.floor(seconds / 2592000);
        if (interval >= 1) {
            return interval + " ê°œì›” ì „";
        }
        interval = Math.floor(seconds / 86400);
        if (interval >= 1) {
            return interval + " ì¼ ì „";
        }
        interval = Math.floor(seconds / 3600);
        if (interval >= 1) {
            return interval + " ì‹œê°„ ì „";
        }
        interval = Math.floor(seconds / 60);
        if (interval >= 1) {
            return interval + " ë¶„ ì „";
        }
        return Math.floor(seconds) + " ì´ˆ ì „";
    }

    // ëª¨ë“  createTime í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ìš”ì†Œë¥¼ ê°€ì ¸ì™€ì„œ ì‹œê°„ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    const createTimeElements = document.querySelectorAll('.createTime');
    createTimeElements.forEach(function(element) {
        const createdTime = element.getAttribute('data-created-at');
        element.innerText = timeSince(createdTime);
    });

    // ìˆ˜ì • ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
    function activateEditField(button) {
        // ë²„íŠ¼ì„ í´ë¦­í•œ ë¶€ëª¨ ìš”ì†Œì¸ ìˆ˜ì • ì¹¸ì„ ì°¾ìŠµë‹ˆë‹¤.
        var editField = button.closest('.row').querySelector('.commentInput');
        
        editField.removeAttribute('readonly');
        editField.focus();
        editField.setSelectionRange(editField.value.length, editField.value.length);

        // ì—°í•„ ì•„ì´ì½˜ì„ ì²´í¬ ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        button.innerHTML = 'âœ…';
    }

    // ì²´í¬ë°•ìŠ¤ê°€ ì•„ë‹Œ ìˆ˜ì • ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
    function handleEditButtonClick(button) {
        // ëŒ“ê¸€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        var selectInput = button.closest('.row').querySelector('.commentInput');
        var commentData = selectInput.value;
        var commentNo = selectInput.getAttribute('data-comm-id');

        fetch("/board/update_comment", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                commentNo: commentNo,
                commentData: commentData
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // ì„œë²„ ì‘ë‹µì— ë”°ë¥¸ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            location.reload();
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });

        // ìš”ì²­ì„ ë³´ë‚´ëŠ” ëŒ€ì‹  ì½˜ì†”ì— ëŒ“ê¸€ ë°ì´í„°ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
        console.log('ëŒ“ê¸€ ë°ì´í„°:', commentData, commentNo);
    }

    function removeData(button){
        removeId = button.getAttribute('data-comm-id');
        fetch("/board/delete_comment", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                removeId: removeId
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // ì„œë²„ ì‘ë‹µì— ë”°ë¥¸ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            location.reload();
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
    }

    // ëª¨ë“  ìˆ˜ì • ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    var editButtons = document.querySelectorAll('.btn-request');
    editButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            if(button.innerHTML == "ğŸ—‘ï¸"){
                if(confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
                    removeData(button);
                }
            }else if(button.innerHTML == "âœ…"){
                handleEditButtonClick(button);
            }else{
                activateEditField(button);
            }
        });
    });

    // Enter í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
    function handleEnterKey(event) {
        if (event.keyCode === 13) {
            // í˜„ì¬ ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            var currentElement = event.target;

            // ì²´í¬ë°•ìŠ¤ê°€ ì•„ë‹ˆê³  ìˆ˜ì • ë²„íŠ¼ì¸ ê²½ìš°ì—ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            if (currentElement.classList.contains('commentInput')) {
                handleEditButtonClick(currentElement);
            }
        }
    }

    // ëª¨ë“  ì…ë ¥ë€ì— keydown ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    var inputFields = document.querySelectorAll('.commentInput');
    inputFields.forEach(function(input) {
        input.addEventListener('keydown', handleEnterKey);
    });

    // í˜ì´ì§€ ë¡œë“œ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
    window.onload = function() {
        // ì´ì „ì— ì €ì¥í•œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        var scrollPosition = sessionStorage.getItem('scrollPosition');

        // ì´ì „ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ ìŠ¤í¬ë¡¤ì„ ì´ë™í•©ë‹ˆë‹¤.
        if (scrollPosition) {
            window.scrollTo(0, scrollPosition);
        }
    };

    // í˜ì´ì§€ unload ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
    window.onbeforeunload = function() {
        // í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
        sessionStorage.setItem('scrollPosition', window.scrollY);
    };

    // ì¢‹ì•„ìš” ë²„íŠ¼ì´ ëˆŒë¦´ ë•Œë§ˆë‹¤ ê°’ì„ toggleí•˜ì—¬ ì„œë²„ì— ì „ë‹¬í•©ë‹ˆë‹¤.
    function toggleLikeButton(button) {
        // ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ì´ë²¤íŠ¸ë¥¼ pass í•œë‹¤.
        const isLogin = button.getAttribute('data-login') === '1';
        if (isLogin === false) {
            return
        }

        const likeOn = button.getAttribute('data-like-on') === '1' ? '0' : '1';
        fetch("/board/set_like", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                likeOn: likeOn
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // ì„œë²„ ì‘ë‹µì— ë”°ë¥¸ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            location.reload();
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
    }

    // ì¢‹ì•„ìš” ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    var likeButtons = document.querySelectorAll('.btn-like');
    likeButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            toggleLikeButton(button);
        });
    });

</script>

{% endblock %}